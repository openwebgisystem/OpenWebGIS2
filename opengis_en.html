<!doctype html>
<html lang="en">
  <head>
  <title>OpenWebGIS 2: open and free GIS online for all of us.</title>
<META name="keywords" content="geographic information system, gis, openwebgis, open source software" >
<meta property="og:url" content="http://opengis.dlinkddns.com/gis/opengis_eng.html" />
 <meta property="og:image" content="http://opengis.dlinkddns.com/gis/imgopen/opengis.png" />
<meta property="og:title" content="OpenWebGIS: open and free GIS online for all of us" />
<meta property="og:description" content="OpenWebGIS is an open source Geographic information system. Version 2.0. It is a web-based system and it functions both in online, and offline modes" />
<link rel="icon" href="imgopen/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="ol/ol.css" type="text/css">
     <link href="ol3-contextmenu/ol3-contextmenu.css" rel="stylesheet">
     <link rel="stylesheet" href="ol3-layerswitcher/ol3-layerswitcher.css" />
     <link rel="stylesheet" href="ol3-popup/ol3-popup.css" />
     
    <style>
    html, body {
  height: 100%;
  padding: 0;
  margin: 0;
  font-family: sans-serif;
  font-size: small;
}
      .map {
        height: 100%;
        width: 100%;
              }
.buttonclass
{
background: radial-gradient(circle at 50% 50%, #CBEDF1, rgb(133, 205, 214), #53C2CF);
border: none;
cursor:pointer;
}
.sizePopupW{}
.sizePopupH{}
 #map .ol-zoomslider {
        top: 0.5em;
        left: 4em;
        right: 8px;
        background-color: rgba(203,237,241,0.4);
        width: 200px;
        height: 15px;
        padding: 0;
        box-shadow: 0 0 5px rgb(133, 205, 214);
        border-radius: 20px;
      }

      #map .ol-zoomslider:hover {
        background-color: rgba(203,237,241,0.6);
      }

      #map .ol-zoomslider-thumb {
        height: 15px;
        width: 15px;
        margin: 0;
        filter: none;
        background-color: rgba(83,194,207,0.6);
        border-radius: 20px;
      }
      #map3 a.ol-zoomslider-handle:hover {
        background-color: rgba(83,194,207,0.7);
      }
    </style>
    <script src="ol/ol.js" type="text/javascript"></script>
   
<script src="ol3-contextmenu/ol3-contextmenu-debug.js"></script>
<script src="ol3-layerswitcher/ol3-layerswitcher.js"></script>
 <script src="ol3-popup/ol3-popup.js"></script>
 <!--<script src="http://maps.google.com/maps/api/js?v=3"></script> -->

    <title>OpenLayers 3 example</title>
  </head>
  <body>
         
      <div id="inf_contacts_id" style="position:absolute;top:2em;left:4em;cursor:pointer;width:170px;z-index:1;height:0px">
      <a ><img width="370" height="145" style="opacity:0.5; cursor:default; pointer-events: none;" src="imgopen/opengis.png"></a>
<a href="https://plus.google.com/112343419546545616455/posts" target="_blank"><img src="imgopen/g.png" ></a>
<a href="https://www.facebook.com/openwebgisPage" target="_blank"><img src="imgopen/f.png" ></a>
<a href="https://www.youtube.com/user/openwebgis" target="_blank"><img src="imgopen/y.png" ></a>
<a href="http://openwebgisystem.blogspot.com" target="_blank" title="Blogger. Infomation, articles, help about OpenWebGIS, JavaScript, OpenLayers, etc"><img src="imgopen/b.png" ></a>
<a href="http://openwebgis.livejournal.com/" target="_blank" title="LiveJournal"><img src="imgopen/lj.png" ></a>
</div>
    <div id="map" class="map">
    <div id="menu_main" style="position: absolute;right: 0.5em; text-align: left;  top: 7em;z-index:2; width:100%; cursor:pointer"><div id="sub_main_menu1" title="Menu" style="position:absolute;right: 0.5em;" onclick=openmenu()><img src='imgopen/menu.png'></div>
     <div id='sub_main_menu2' style='display:none'>
       <div id="add_layer_id" onclick=openfile_layermenu() style="position: absolute;right: 0.5em; text-align: left;  top: 2.5em;z-index:2;  cursor:pointer; display:block;background:white; font-size:100%">Add Layer from the file</div>
      <div id="modify_layer_id" onclick=modify_layermenu() style="position: absolute;right: 0.5em; text-align: left;  top: 4.5em;z-index:2;  cursor:pointer; display:block;background:white">Modify vector Layer geometry</div>
      <div id="style_layer_id" onclick=style_layermenu() style="position: absolute;right: 0.5em; text-align: left;  top: 6.5em;z-index:2;  cursor:pointer; display:block;background:white">Modify vector Layer style</div>
      <div id="export_layer_id" onclick=export_layermenu() style="position: absolute;right: 0.5em; text-align: left;  top: 8.5em;z-index:2;  cursor:pointer; display:block;background:white">Export vector Layer</div>
<div id="geolocation_layer_id" onclick=geolocation_layermenu() style="position: absolute;right: 0.5em; text-align: left;  top: 10.5em;z-index:2;  cursor:pointer; display:block;background:white">Get your geolocation</div>
    </div>
    </div>
        </div>
        <div style="bottom: 4em; left: 0; min-width: 200px;  position: absolute;" id="coordinat_position_id"></div>
    <script type="text/javascript">
    var fileLayer; var layer_vector_group; var ModifyMode=0;var layer_base_group;var fileZIP;var popupheightOWG=0; var popupwidthOWG=0;
    var Movewindowblock=''; var delta_x = 0;  var delta_y = 0;
var intervaTimeGeoLoc=0;
var new_layer_MyLocationInterval=0;
var new_layer_MyLocationIntervalTrack=0;
    function getpmap()
    {
    
    var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
 var postobj={};postobj.topTop=topTop; postobj.leftLeft=leftLeft;
 return postobj;
    }
function geolocation_layermenu()
{
/*for (var i=0;i<document.getElementById("menu_main").childNodes.length;i++)
     {if(document.getElementById("menu_main").childNodes[i].id!=="sub_main_menu1"&&document.getElementById("menu_main").childNodes[i].style){document.getElementById("menu_main").childNodes[i].style.display='none';}}*/
     document.getElementById("sub_main_menu2").style.display='none';
    var body = document.body;
    var DivEditeLeg=document.createElement("div");DivEditeLeg.style.cursor="default"

DivEditeLeg.id="id_divGeolocation_layer";
//DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.innerHTML='<div id="id_id_divGeolocationlayers" style="background:#ffffff; color:#000000;z-index: 6000;position:absolute;overflow:hidden; border: 1px solid black;right: 0.5em; top: 2.5em;">'+
'<a>Tracking position in real time:</a><br>'+
'<a style="font-size: 11px;">Updating in seconds:</a><input type="text" size="5" id="id_MyLocatSec" value="10" title="Set interval for updating in seconds"/><button title="After clicking this button, you will receive a set of points with your geolocation, which is updated approximately in the number of seconds you have specified." type=button class=buttonclass onclick=StartMyGeoLocation()><a style="font-size: 11px;">start</a></button><button class=buttonclass type=button onclick=StopMyGeoLocation()><a style="font-size: 11px;">stop</a></button><br>'+
'<input type="checkbox" id="id_LastPointLoc" title="" value="checkbox"/>leave the last: <input  type="text" size="6" id="leaveLocP_id" value="10"/>points<br>'+
'<a>Name of Layer:</a><input type="text" size="15" id="id_MyLocatName" value="MyLocation"/><br>'+
'<input type="checkbox" id="id_MoveMyLoc" title="" value="checkbox" checked/><a style="font-size: 11px;">move extent of the map to the position.</a><br><a style="font-size: 11px;">square size(extent) in degrees</a><input type="text" style="font-size: 11px;" title="size square in degrees" size="4" id="MyPosmovemap_val" value="0.005"/><br>'+
'<input type="checkbox" id="id_TrackMyLocTime" title="" value="checkbox" checked/><a>Add Track</a><br>'+
/*'<input type="checkbox" id="id_PointSaveServerLocat" title="Tick to save the data of your location on the server of OpenWebGIS. The data is saved only after pressing the button /start/. After pressing the button /stop/ the recording (saving) stops. NOTE: If you have activated the location saving on the server, then after pressing the start button you will get an alphanumeric identifier id of your records, it will appear in the text box on the right. This identifier can be used by you or by someone else (whom you will give it) to get the information about your location by entering id in the appropriate box under the name /insert id of geolocation/. This field is located below in the section /Click to locate other objects or display recorded locations:/" value="checkbox" />'+
'<a style="font-size: 11px;">save location</a><a style="font-size: 12px;"> id:</a><textarea title="If you have activated the locations saving on the server, then after pressing the start button you will get IN THIS BOX an alphanumeric identifier id of your records" style="height:20px; width:120px" id="id_PointSaveLinkLocat" type="text" size="10" value=""></textarea>'+*/
'<p> <button class=buttonclass type=button onclick=GetMyGeoLocation() title="After each clicking this button, you will get one point with your geolocation (position)">Get current position</button></p>'+
//'<input type="checkbox" id="Id_KavikIsInFileWeb" value="checkbox"/>click if field contains inverted commas'+
'<p style="left: 0px; bottom: 0px; position: relative; height: 15px;"><button class=buttonclass style="position: absolute; left: 0px; bottom: 0px;" type=button onclick=CloseGeolocationWindow()>Close</button> <button class=buttonclass type=button style="position: absolute; right: 0px; bottom: 0px;" onclick=ExportGeoLocLayerToFile2()>Export</button></p>'+
//'<p></p>'+
'</div>';

if(!document.getElementById("id_divGeolocation_layer"))
{document.getElementById('menu_main').appendChild(DivEditeLeg);
document.getElementById("id_divGeolocation_layer").childNodes[0].addEventListener("mousedown", saveXY, false);
document.getElementById("id_divGeolocation_layer").childNodes[0].addEventListener("touchstart", saveXY, false);
}
}
function GetMyGeoLocation()
{
if (navigator.geolocation)     {     navigator.geolocation.getCurrentPosition(showPosition,showError);     }   
else{alert("Geolocation is not supported by this browser.");return;}   
}
function ExportGeoLocLayerToFile2()
{
CloseGeolocationWindow();export_layermenu();
}
function CloseGeolocationWindow()
{if(intervaTimeGeoLoc!==0){clearInterval(intervaTimeGeoLoc);intervaTimeGeoLoc=0;}
document.getElementById("id_divGeolocation_layer").parentNode.removeChild(document.getElementById("id_divGeolocation_layer"))  }
function StartMyGeoLocation()
{
if(intervaTimeGeoLoc!==0){alert("You must stop previous process");return;}
var err=(document.getElementById("id_MyLocatSec").value/document.getElementById("id_MyLocatSec").value) ? true : false; 
if(err==false){alert("error in seconds");return;}
var ArrayFeatures=[];
var vectorSource = new ol.source.Vector({    });
     var style = new ol.style.Style({
     image: new ol.style.Circle(  ({  radius: 3,  fill: new ol.style.Fill({ color: '#FF9000'  }),
             stroke: new ol.style.Stroke({        color: '#ffff00',        width: 1    })
        }))  ,
    stroke: new ol.style.Stroke({ color: '#ffff00', width: 1  }),
    fill: new ol.style.Fill({
       color: [255, 144, 0, .6]
        //color:"#FF9000",
            })
});
          new_layer_MyLocationInterval = new ol.layer.Vector({source: vectorSource, style: style,    });
      
      new_layer_MyLocationInterval.set('name', document.getElementById("id_MyLocatName").value)
      new_layer_MyLocationInterval.set('title', document.getElementById("id_MyLocatName").value)
     var zindex=0;
map.getLayers().getArray().forEach(function(layer_arr){layer_arr.getLayers().getArray().forEach(function(layer_arr2){if(layer_arr2.getZIndex()>zindex&&layer_arr2.get('title')!=='Markers'){zindex=layer_arr2.getZIndex();}})})
new_layer_MyLocationInterval.setZIndex(zindex+1);
layer_vector_group.getLayers().push(new_layer_MyLocationInterval)
if (document.getElementById("id_TrackMyLocTime").checked==true)
{
var vectorSource = new ol.source.Vector({ });
     var style = new ol.style.Style({
     image: new ol.style.Circle(  ({
            radius: 3,  fill: new ol.style.Fill({ color: '#FF9000'  }),
             stroke: new ol.style.Stroke({        color: '#ffff00',        width: 1    })
        }))  ,
    stroke: new ol.style.Stroke({ color: '#ffff00', width: 1  }),
    fill: new ol.style.Fill({
       color: [255, 144, 0, .6]
        //color:"#FF9000",
            })
});
           new_layer_MyLocationIntervalTrack= new ol.layer.Vector({source: vectorSource, style: style,    });
      
      new_layer_MyLocationIntervalTrack.set('name', document.getElementById("id_MyLocatName").value+"Track")
      new_layer_MyLocationIntervalTrack.set('title', document.getElementById("id_MyLocatName").value+"Track")
     var zindex=0;
map.getLayers().getArray().forEach(function(layer_arr){layer_arr.getLayers().getArray().forEach(function(layer_arr2){if(layer_arr2.getZIndex()>zindex&&layer_arr2.get('title')!=='Markers'){zindex=layer_arr2.getZIndex();}})})
new_layer_MyLocationIntervalTrack.setZIndex(zindex+1);
//map.getView().fit(vectorSource.getExtent(), map.getSize());
layer_vector_group.getLayers().push(new_layer_MyLocationIntervalTrack)
}
/*if(document.getElementById("id_PointSaveServerLocat").checked==true)
////////
{var strsave='';
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp.open('POST','/linklocat.php?rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
 xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("no data");return;}
var varlink=xmlhttp.responseText;
document.getElementById("id_PointSaveLinkLocat").value=varlink;
}}
xmlhttp.send('l='+strsave);
}*//////////////////////////
if (navigator.geolocation)     {     navigator.geolocation.getCurrentPosition(showPositionInterval,showError);     }   
else{alert("Geolocation is not supported by this browser.");return;}  
intervaTimeGeoLoc=setInterval( function(){

if (navigator.geolocation)     {     navigator.geolocation.getCurrentPosition(showPositionInterval,showError);     }   
else{alert("Geolocation is not supported by this browser.");return;}  

},parseInt(document.getElementById("id_MyLocatSec").value*1000));
}
function StopMyGeoLocation()
{
if(intervaTimeGeoLoc!==0){clearInterval(intervaTimeGeoLoc);intervaTimeGeoLoc=0;}
}
function showPosition(position)   
{  var lat=position.coords.latitude;  var lon=position.coords.longitude;  var alt=position.coords.altitude; var sp=position.coords.speed; var timeS=new Date(position.timestamp); 
 var geom = new ol.geom.Point(ol.proj.transform([lon*1, lat*1],  'EPSG:4326', 'EPSG:3857'));
        var feature = new ol.Feature(geom);   
var now=timeS;var Y=now.getFullYear();
var M=now.getMonth()+1;if(parseInt(M)<10){M='0'+M;}var D=now.getDate();if(parseInt(D)<10){D='0'+D;}
var H=now.getHours();if(parseInt(H)<10){H='0'+H;}var MM=now.getMinutes();if(parseInt(MM)<10){MM='0'+MM;}
var S=now.getSeconds();if(parseInt(S)<10){S='0'+S;}var neD=Y+'-'+M+'-'+D+'T'+H+':'+MM+':'+S;
var attr={};attr.latitude=lat; attr.longitude=lon;attr.altitude=alt;attr.speed=sp;attr.time=neD; //var strsave=lon+";"+lat+";"+alt+";"+sp+";"+neD;
feature.setProperties(attr); 
var vectorSource = new ol.source.Vector({    });
     var style = new ol.style.Style({
     image: new ol.style.Circle(  ({  radius: 3,  fill: new ol.style.Fill({ color: '#FF9000'  }),
             stroke: new ol.style.Stroke({        color: '#ffff00',        width: 1    })
        }))  ,
    stroke: new ol.style.Stroke({ color: '#ffff00', width: 1  }),
    fill: new ol.style.Fill({
       color: [255, 144, 0, .6]
        //color:"#FF9000",
            })
});
         var new_layer_MyLocation = new ol.layer.Vector({source: vectorSource, style: style,    });
      
      new_layer_MyLocation.set('name', document.getElementById("id_MyLocatName").value)
      new_layer_MyLocation.set('title', document.getElementById("id_MyLocatName").value)
     var zindex=0;
map.getLayers().getArray().forEach(function(layer_arr){layer_arr.getLayers().getArray().forEach(function(layer_arr2){if(layer_arr2.getZIndex()>zindex&&layer_arr2.get('title')!=='Markers'){zindex=layer_arr2.getZIndex();}})})
new_layer_MyLocation.setZIndex(zindex+1);
layer_vector_group.getLayers().push(new_layer_MyLocation)
new_layer_MyLocation.getSource().addFeature(feature); flashFeature(feature);


if (document.getElementById("id_MoveMyLoc").checked==true)
{
var valg=parseFloat(document.getElementById("MyPosmovemap_val").value);var x1s=lon-valg;var y1s=lat-valg;var x2s=lon+valg;var y2s=lat+valg;
var bounds = ol.proj.transformExtent( [x1s,y1s,x2s,y2s], "EPSG:4326", "EPSG:3857");
map.getView().fit( bounds, map.getSize() );

}
}
function showPositionInterval(position)
{
var lat=position.coords.latitude;  var lon=position.coords.longitude;  var alt=position.coords.altitude; var sp=position.coords.speed; var timeS=new Date(position.timestamp); 
 var geom = new ol.geom.Point(ol.proj.transform([lon*1, lat*1],  'EPSG:4326', 'EPSG:3857'));
        var feature = new ol.Feature(geom);   
var now=timeS;var Y=now.getFullYear();
var M=now.getMonth()+1;if(parseInt(M)<10){M='0'+M;}var D=now.getDate();if(parseInt(D)<10){D='0'+D;}
var H=now.getHours();if(parseInt(H)<10){H='0'+H;}var MM=now.getMinutes();if(parseInt(MM)<10){MM='0'+MM;}
var S=now.getSeconds();if(parseInt(S)<10){S='0'+S;}var neD=Y+'-'+M+'-'+D+'T'+H+':'+MM+':'+S;
var attr={};attr.latitude=lat; attr.longitude=lon;attr.altitude=alt;attr.speed=sp;attr.time=neD; 
feature.setProperties(attr); 
new_layer_MyLocationInterval.getSource().addFeature(feature); flashFeature(feature);

if(document.getElementById("id_LastPointLoc").checked==true)
{var u=parseInt(document.getElementById("leaveLocP_id").value)+1;if(new_layer_MyLocationInterval.getSource().getFeatures().length==u)
{if(new_layer_MyLocationInterval.features[0]){new_layer_MyLocationInterval.removeFeature(new_layer_MyLocationInterval.getSource().getFeatures()[0])}}
if(new_layer_MyLocationInterval.getSource().getFeatures().length>u){for(var vb=0;vb<u;vb++){new_layer_MyLocationInterval.getSource().removeFeature(new_layer_MyLocationInterval.getSource().getFeatures()[vb])}}
}

if (document.getElementById("id_MoveMyLoc").checked==true)
{
var valg=parseFloat(document.getElementById("MyPosmovemap_val").value);var x1s=lon-valg;var y1s=lat-valg;var x2s=lon+valg;var y2s=lat+valg;
var bounds = ol.proj.transformExtent( [x1s,y1s,x2s,y2s], "EPSG:4326", "EPSG:3857");
map.getView().fit( bounds, map.getSize() );

}
if (document.getElementById("id_TrackMyLocTime").checked==true)
{var pointList=[];
var sd1=new Date(new_layer_MyLocationInterval.getSource().getFeatures()[0].getProperties().time)
sd1=sd1.getTime()
var minDistC = parseInt(sd1);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < new_layer_MyLocationInterval.getSource().getFeatures().length; ++ia) { sd2=new Date(new_layer_MyLocationInterval.getSource().getFeatures()[ia].getProperties().time);var sd2=sd2.getTime();var NumSS=sd2;
 if (NumSS>parseFloat(maxDistC) ){ maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var timemin=minDistC;var timemax=maxDistC;
var timeInter=(timemax-timemin)/1000;
for(var ty=0;ty<new_layer_MyLocationInterval.getSource().getFeatures().length;ty++)
{var newPoint1 =  [new_layer_MyLocationInterval.getSource().getFeatures()[ty].getGeometry().getCoordinates()[0],
new_layer_MyLocationInterval.getSource().getFeatures()[ty].getGeometry().getCoordinates()[1]];
pointList.push(newPoint1);
if(new_layer_MyLocationInterval.getSource().getFeatures()[ty+1])
{var newPoint1 = [new_layer_MyLocationInterval.getSource().getFeatures()[ty].getGeometry().getCoordinates()[0],
new_layer_MyLocationInterval.getSource().getFeatures()[ty].getGeometry().getCoordinates()[1]];
pointList.push(newPoint1);}
else{var newPoint1 = [new_layer_MyLocationInterval.getSource().getFeatures()[ty].getGeometry().getCoordinates()[0],
new_layer_MyLocationInterval.getSource().getFeatures()[ty].getGeometry().getCoordinates()[1]];
pointList.push(newPoint1);}
}
 var line = new ol.geom.LineString(pointList);
new_layer_MyLocationIntervalTrack.getSource().clear();

var lineTr = new ol.Feature({
    geometry: line
  });

new_layer_MyLocationIntervalTrack.getSource().addFeature(lineTr);
lineTr.setProperties({'travel_time_sec':timeInter});
lineTr.setProperties({'travel_time_min':timeInter/60});
//var areaP=lineTr.clone().geometry.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
//areaL=areaP.getGeodesicLength(new OpenLayers.Projection("EPSG:4326"));
var Line_proj=line.clone().transform('EPSG:3857','EPSG:4326')
var length=Line_proj.getLength()
lineTr.setProperties({'travel_dist_meter':length});
lineTr.setProperties({'travel_dist_km':length/1000});
lineTr.setProperties({'avg_speed_km_hour':(length/1000)/((timeInter/60)/60)});



} }
  var duration = 3000;
      function flashFeature(feature) {
        var start = new Date().getTime();
        var listenerKey;

        function animate(event) {
          var vectorContext = event.vectorContext;
          var frameState = event.frameState;
          var flashGeom = feature.getGeometry().clone();
          var elapsed = frameState.time - start;
          var elapsedRatio = elapsed / duration;
          // radius will be 5 at start and 30 at end.
          var radius = ol.easing.easeOut(elapsedRatio) * 55 + 5;
          var opacity = ol.easing.easeOut(1 - elapsedRatio);

          var style = new ol.style.Style({
            image: new ol.style.Circle({
              radius: radius,
              snapToPixel: false,
              stroke: new ol.style.Stroke({
                color: 'rgba(255, 0, 0, ' + opacity + ')',
                width: 7.5 + opacity
              })
            })
          });

          vectorContext.setStyle(style);
          vectorContext.drawGeometry(flashGeom);
          if (elapsed > duration) {
            ol.Observable.unByKey(listenerKey);
            return;
          }
          // tell OL3 to continue postcompose animation
          map.render();
        }
        listenerKey = map.on('postcompose', animate);
      }
function showError(error)   
{   switch(error.code)      
{     case error.PERMISSION_DENIED:       alert("User denied the request for Geolocation.");       break;
     case error.POSITION_UNAVAILABLE:       alert("Location information is unavailable.");       break; 
    case error.TIMEOUT:       alert("The request to get user location timed out.");      break;  
   case error.UNKNOWN_ERROR:       alert("An unknown error occurred.");       break;     }   }
  function style_layermenu()
   {if(!document.getElementById("legend_js_id"))
  { var scriptB0 = document.createElement("script"); scriptB0.src = 'js/legend.js'; 
 scriptB0.type = 'text/javascript';  scriptB0.id="legend_js_id";
scriptB0.async=false;document.head.appendChild(scriptB0);scriptB0.onload= function(){initLegend()};

var scriptB1 = document.createElement("script"); scriptB1.src = 'colorpicker/color-picker.js'; 
 scriptB1.type = 'text/javascript';  scriptB1.id="color-picker_js_id";
document.head.appendChild(scriptB1);
var styleColor = document.createElement('link');styleColor.href = 'colorpicker/color-picker.css';
styleColor.rel = "stylesheet";
styleColor.type = 'text/css';styleColor.id='color-picker_css_id';document.head.appendChild(styleColor);

}else{initLegend()}
}
   
    function export_layermenu()
    {
    
    if(!document.getElementById("export_vector_to_file_id"))
   { var scriptB0 = document.createElement("script"); scriptB0.src = 'js/export_vector_to_file.js'; 
 scriptB0.type = 'text/javascript';  scriptB0.id="export_vector_to_file_id";
scriptB0.async=false;document.head.appendChild(scriptB0);scriptB0.onload= function(){export_layermenuStart()};}
else{export_layermenuStart()}
    }
    function export_layermenuStart()
    {
    /*for (var i=0;i<document.getElementById("menu_main").childNodes.length;i++)
     {if(document.getElementById("menu_main").childNodes[i].id!=="sub_main_menu1"&&document.getElementById("menu_main").childNodes[i].style){document.getElementById("menu_main").childNodes[i].style.display='none';}}*/
     document.getElementById("sub_main_menu2").style.display='none';
    var body = document.body;
    var DivEditeLeg=document.createElement("div");DivEditeLeg.style.cursor="default";
DivEditeLeg.id="id_divExport_layer";
//DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.innerHTML='<div id="id_id_divexportlayers" style="background:#ffffff; color:#000000;z-index: 6000;position:absolute;overflow:hidden; border: 1px solid black;right: 0.5em; top: 2.5em;">'+
'<a>Select Layer to export</a><br>'+
'&nbsp;<select id="id_Export_Layer_select" onchange=onchangeSelectExportLayer() ><option value="0">select layer</option></select><br>'+
'<a>Select format to export of Layer:</a><br>'+
'&nbsp;<select id="id_Export_format_select" onchange=onchangeSelectExportFormat() >'+
'<option value="0">select format</option>'+//0
'<option value="wkt">Export Layer to WKT file</option>'+//1
'<option value="gml2" disabled>Export Layer to GML2 file</option>'+//2
'<option value="gml3">Export Layer to GML3 file</option>'+//3
'<option value="geojson">Export Layer to GeoJSON file</option>'+//4
'<option value="gpx">Export Layer to GPX file</option>'+//5
'<option value="kml">Export Layer to KML file</option>'+//6
'<option value="csv">Export Layer to CSV file</option>'+//7
'<option disabled value="shape">Export Layer to Shapefile (zipped)</option>'+//8
'</select>&nbsp;'+
'<div id="csv_option_id_div_export" style="display:none"><a>Please select separation symbol in CSV file :</a><br>'+
 '<select id="sepTXTcsv_id_export"> '+
 '<option selected value=";">; semicolon</option>'+
'<option selected value=",">, comma</option>'+
'</select><br>'+
'or insert any other symbol:<br>'+
'<input type="text" size="3" id="sepTXTcsvw_idSep_exp" value=""/>'+
'</div>'+
//'<input type="checkbox" id="Id_KavikIsInFileWeb" value="checkbox"/>click if field contains inverted commas'+
'<p style="left: 0px; bottom: 0px; position: relative; height: 15px;"><button class=buttonclass style="position: absolute; left: 0px; bottom: 0px;" type=button onclick=CloseExportWindow()>Close</button> <button class=buttonclass type=button style="position: absolute; right: 0px; bottom: 0px;" onclick=ExportLayerToFile()>Export</button></p>'+
//'<p></p>'+
'</div>';

if(!document.getElementById("id_divExport_layer"))
{document.getElementById('menu_main').appendChild(DivEditeLeg);

document.getElementById("id_divExport_layer").childNodes[0].addEventListener("mousedown", saveXY, false);
document.getElementById("id_divExport_layer").childNodes[0].addEventListener("touchstart", saveXY, false);

}
document.getElementById("id_Export_Layer_select").innerHTML='';
var t=document.createElement('option');t.value='select layer';t.text='select layer';document.getElementById("id_Export_Layer_select").appendChild(t);
layer_vector_group.getLayers().forEach(function(layer_arr){var t=document.createElement('option');t.value=layer_arr.get('name');t.text=layer_arr.get('name');document.getElementById("id_Export_Layer_select").appendChild(t);})
if(document.getElementById("id_Export_Layer_select").options.length==1){alert("No vector Layers for export")}
    } 
    
    function CloseExportWindow()
    {
    document.getElementById("id_divExport_layer").parentNode.removeChild(document.getElementById("id_divExport_layer")) 
    }
    function modify_layermenu()
    {if (ModifyMode==0)
    {ModifyMode=1;document.getElementById("modify_layer_id").innerHTML='Modification mode ';map.addInteraction(modify);}
    else{ModifyMode=0;document.getElementById("modify_layer_id").innerHTML='Modify vector Layer';map.removeInteraction(modify);}
    }
    function openfile_layermenu()
    {
       document.getElementById("sub_main_menu2").style.display='none';
    var body = document.body;
    var DivEditeLeg=document.createElement("div");DivEditeLeg.style.cursor="default";
DivEditeLeg.id="id_divloadfiles_layer";
//DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.innerHTML='<div id="id_id_divuploadfiles0" style="background:#ffffff; color:#000000;z-index: 6000;position:absolute;overflow:hidden; border: 1px solid black;right: 0.5em; top: 2.5em;">'+
'<a>Add Layer from local file:</a><br>'+
'&nbsp;<input class=buttonclass id="id_uploadFilelayer" name="file" type="file"></br>&nbsp;<select id="id_format_select" onchange=onchangeSelectFormat() name="format_select">'+
'<option value="0">select format</option>'+//0
'<option value="wkt">New Layer from WKT file</option>'+//1
'<option value="gml2">New Layer from GML2 file</option>'+//2
'<option value="gml3">New Layer from GML3 file</option>'+//3
'<option value="geojson">New Layer from GeoJSON file</option>'+//4
'<option value="gpx">New Layer from GPX file</option>'+//5
'<option value="kml">New Layer from KML file</option>'+//6
'<option value="csv">New Layer from CSV file</option>'+//7
'<option value="shape">New Layer from Shapefile (zipped)</option>'+//8
'</select>&nbsp;'+
'<div id="csv_option_id_div" style="display:none"><a>Please select separation symbol in CSV file :</a><br>'+
 '<select id="sepTXTcsv_id"> '+
 '<option selected value=";">; semicolon</option>'+
'<option selected value=",">, comma</option>'+
'</select><br>'+
'or insert any other symbol:<br>'+
'<input type="text" size="3" id="sepTXTcsvw_idSep" value=""/>'+
'<input type="checkbox" id="Id_KavikIsInFileWeb" value="checkbox"/>click if field contains inverted commas</div>'+
'<br>New Layer name<input type="text" size="18" id="newLayer_idname" value=""/>'+
'<p style="left: 0px; bottom: 0px; position: relative; height: 15px;"><button class=buttonclass style="position: absolute; left: 0px; bottom: 0px;" type=button onclick=CloseUploadWindow()>Close</button> <button class=buttonclass type=button style="position: absolute; right: 0px; bottom: 0px;" onclick=AddFiletoMap()>Add</button></p>'+
//'<p></p>'+
'</div>';

if(!document.getElementById("id_divloadfiles_layer"))
{document.getElementById('menu_main').appendChild(DivEditeLeg);
document.getElementById('id_uploadFilelayer').addEventListener('change', readSingleFile, false);

document.getElementById("id_divloadfiles_layer").childNodes[0].addEventListener("mousedown", saveXY, false);
document.getElementById("id_divloadfiles_layer").childNodes[0].addEventListener("touchstart", saveXY, false);
}

    }
    function onchangeSelectFormat()
{
if(document.getElementById("id_format_select").value=='csv'){document.getElementById("csv_option_id_div").style.display="block"}else{document.getElementById("csv_option_id_div").style.display="none"}
}
function readSingleFile(evt)
{fileLayer = evt.target.files[0]; 
if(fileLayer.name.split(".")[1]=="gml"){document.getElementById("id_format_select").options[2].selected=true;}
//if(fileLayer.name.split(".")[1]=="gml3"){document.getElementById("id_format_select").options[3].selected=true;}
if(fileLayer.name.split(".")[1].toLowerCase()=="zip"){document.getElementById("id_format_select").options[8].selected=true;}
if(fileLayer.name.split(".")[1]=="json"||fileLayer.name.split(".")[1]=="geojson"){document.getElementById("id_format_select").options[4].selected=true;}
if(fileLayer.name.split(".")[1]=="kml"){document.getElementById("id_format_select").options[6].selected=true;}
if(fileLayer.name.split(".")[1]=="gpx"){document.getElementById("id_format_select").options[5].selected=true;}
if(fileLayer.name.split(".")[1]=="csv"){document.getElementById("id_format_select").options[7].selected=true;document.getElementById("csv_option_id_div").style.display="block"}
if(fileLayer.name.split(".")[1]=="wkt"){document.getElementById("id_format_select").options[1].selected=true;}
if(document.getElementById("id_format_select").value!=="csv"){document.getElementById("csv_option_id_div").style.display="none"}
}
function additionalAddFiletoMap()
{if(document.getElementById("id_format_select").value=="gml2"){New_LayerGML2()}
if(document.getElementById("id_format_select").value=="gml3"){New_LayerGML3()}
if(document.getElementById("id_format_select").value=="shape"){UploadShape()}
if(document.getElementById("id_format_select").value=="geojson"){New_LayerJSON()}
if(document.getElementById("id_format_select").value=="kml"){New_LayerKML()}
if(document.getElementById("id_format_select").value=="gpx"){New_LayerGPX()}
if(document.getElementById("id_format_select").value=="csv"){OK_fileTXT2()}
if(document.getElementById("id_format_select").value=="wkt"){New_LayerWKT()}}
    function CloseUploadWindow()
    {    document.getElementById("id_divloadfiles_layer").parentNode.removeChild(document.getElementById("id_divloadfiles_layer"))    }
    function AddFiletoMap()
{ var exit_var=0;
layer_vector_group.getLayers().forEach(function(layer_arr)
{if(document.getElementById('newLayer_idname').value==''&&layer_arr.get('name')==fileLayer.name){alert('Sorry, Layer with such a name is already on the map. Please set a new name of the Layer.');exit_var=1;return;}

if(document.getElementById('newLayer_idname').value!==''&&layer_arr.get('name')==document.getElementById('newLayer_idname').value){alert('Sorry, Layer with such name also is on the map. Please set new name');exit_var=1;return;}
})
if(exit_var==1){return;}

if(document.getElementById("id_format_select").value=='0'){alert ("Please select format"); return;}if(!document.getElementById("proj4_script_id"))
{var scriptB0 = document.createElement("script"); scriptB0.src = 'loadshp/proj4.js'; 
 scriptB0.type = 'text/javascript';  scriptB0.id="proj4_script_id";
scriptB0.async=false;document.head.appendChild(scriptB0);scriptB0.onload= function(){};


var scriptB3 = document.createElement("script"); scriptB3.src = 'loadshp/jszip.js'; 
 scriptB3.type = 'text/javascript';  scriptB3.id="jszip_js_script_id";
scriptB3.async=false;document.head.appendChild(scriptB3);scriptB3.onload= function(){};
var scriptB2 = document.createElement("script"); scriptB2.src = 'loadshp/jszip-utils.js'; 
 scriptB2.type = 'text/javascript';  scriptB2.id="jszip_utils_js_script_id";
scriptB2.async=false;document.head.appendChild(scriptB2);scriptB2.onload= function(){};
var scriptB4 = document.createElement("script"); scriptB4.src = 'loadshp/preprocess.js'; 
 scriptB4.type = 'text/javascript';  scriptB4.id="jpreprocess_js_script_id";
scriptB4.async=false;document.head.appendChild(scriptB4);scriptB4.onload= function(){};
var scriptB5 = document.createElement("script"); scriptB5.src = 'loadshp/preview.js'; 
 scriptB5.type = 'text/javascript';  scriptB5.id="preview_js_script_id";
scriptB5.async=false;document.head.appendChild(scriptB5);scriptB5.onload= function(){};
var scriptAddLayer = document.createElement("script"); 
scriptAddLayer.src = 'js/add_layers_fromfile.js'; 
 scriptAddLayer.type = 'text/javascript'; 
 scriptAddLayer.id="uploadfilejs_id";
scriptAddLayer.async=false;document.head.appendChild(scriptAddLayer);
scriptAddLayer.onload=function(){additionalAddFiletoMap()}  }
else
{
additionalAddFiletoMap()
}
}
function isTouchDevice(){ 
	try{
		document.createEvent("touchevent"); 
		return true;
	}catch(e){
		return false;
	}
	
}
    function openmenu()
    {
    document.getElementById("sub_main_menu2").style.display=='none'?document.getElementById("sub_main_menu2").style.display='block':document.getElementById("sub_main_menu2").style.display='none';

var children=document.getElementById("sub_main_menu2").childNodes;rtt=children; 


if(document.getElementById("sub_main_menu2").style.display=='block')
{
if(isTouchDevice())
{
for(var i=0;i<children.length;i++)
{if(children[i].innerHTML){children[i].style.fontSize='2em';var newTop=children[i].style.top.split('em')*1+1;children[i].style.top=newTop+'em'; }}
}
  var lengthElem=0;  for(var i=0;i<children.length;i++)
{if(children[i].innerHTML){if(children[i].offsetWidth>lengthElem){lengthElem=children[i].offsetWidth}}}
for(var i=0;i<children.length;i++)
{if(children[i].innerHTML){children[i].style.width=lengthElem+20+"px"}}
}
    /*document.getElementById("add_layer_id").style.display=='none'?document.getElementById("add_layer_id").style.display='block':document.getElementById("add_layer_id").style.display='none';
    document.getElementById("modify_layer_id").style.display=='none'?document.getElementById("modify_layer_id").style.display='block':document.getElementById("modify_layer_id").style.display='none';
    document.getElementById("style_layer_id").style.display=='none'?document.getElementById("style_layer_id").style.display='block':document.getElementById("style_layer_id").style.display='none';
    document.getElementById("export_layer_id").style.display=='none'?document.getElementById("export_layer_id").style.display='block':document.getElementById("export_layer_id").style.display='none';
document.getElementById("geolocation_layer_id").style.display=='none'?document.getElementById("geolocation_layer_id").style.display='block':document.getElementById("geolocation_layer_id").style.display='none';*/
    }
    var rtt; 
      var view = new ol.View({
        center: [0, 0],
        zoom: 4,
        minZoom: 2,
        maxZoom: 20
      }),
      vectorLayerMarkers = new ol.layer.Vector({
      title: 'Markers',
             zIndex:100000,           
        source: new ol.source.Vector()
      }),
      
      baseLayerOSM = new ol.layer.Tile({
                        title: 'OSM',
                        type: 'base',
        source: new ol.source.OSM()
      }),
      layer_vector_group=new ol.layer.Group({'title': 'Vector Layers',layers:[]});
      layer_base_group=new ol.layer.Group({'title': 'Basemaps',layers:[]});
      baseLayerOSMBingAerialWithLabels=new ol.layer.Tile({
          visible: false,
          preload: Infinity,
          title: 'Bing Aerial with labels',
          type: 'base',
          source: new ol.source.BingMaps({
            key: '',
                  
            imagerySet: 'AerialWithLabels'
            // use maxZoom 19 to see stretched tiles instead of the BingMaps
            // "no photos at this zoom level" tiles
            // maxZoom: 19
          })          })  ;
          layer_base_group.getLayers().push(baseLayerOSM);
          layer_base_group.getLayers().push(baseLayerOSMBingAerialWithLabels);
          baseLayerOSMBingAerialWithLabels.on('change:visible', function(e) 
          {
         
      if(baseLayerOSMBingAerialWithLabels.getVisible()==true)
         { var scriptB0 = document.createElement("script"); scriptB0.src = 'js/getvalue.js'; 
 scriptB0.type = 'text/javascript';  scriptB0.id="getvalue_script_id";
scriptB0.async=false;document.head.appendChild(scriptB0);scriptB0.onload= function()
{

baseLayerOSMBingAerialWithLabels.setSource(new ol.source.BingMaps({ key: returnValue().split("_")[1]+returnValue().split("_")[0],imagerySet: 'AerialWithLabels'  }) );
document.getElementById("getvalue_script_id").parentNode.removeChild(document.getElementById("getvalue_script_id"));console.clear()};}
else
{baseLayerOSMBingAerialWithLabels.setSource(new ol.source.BingMaps({ key: '',imagerySet: 'AerialWithLabels'  }) )}
          })

      map = new ol.Map({
        target: document.getElementById('map'),
        view: view,
        layers: [ layer_vector_group,layer_base_group]
      }),
     
      elastic = function(t) {
        return Math.pow(2, -10 * t) * Math.sin((t - 0.075) * (2 * Math.PI) / 0.3) + 1;
      },
      center = function(obj){ 
        view.animate({
          duration: 2000,
         //easing: elastic,
          center: obj.coordinate,
         rotation: 2*Math.PI
        });
        //map.beforeRender(pan);
        //view.setCenter(obj.coordinate);
      },
      marker = function(obj){
        var coord4326 = ol.proj.transform(obj.coordinate, 'EPSG:3857', 'EPSG:4326'),
            template = 'Coordinate is ({x} | {y})',
            iconStyle = new ol.style.Style({
              image: new ol.style.Icon({
                scale: .6,
                src: 'ol3-contextmenu/img/pin_drop.png'
              }),
              text: new ol.style.Text({
                offsetY: 25,
                text: ol.coordinate.format(coord4326, template, 2),
                font: '15px Open Sans,sans-serif',
                fill: new ol.style.Fill({ color: '#111' }),
                stroke: new ol.style.Stroke({
                  color: '#eee', width: 2
                })
              })
            }),
            feature = new ol.Feature({
              type: 'removable',
              geometry: new ol.geom.Point(obj.coordinate)
            });
        
        feature.setStyle(iconStyle);
        vectorLayerMarkers.getSource().addFeature(feature);
      };

  var contextmenu_items = [
    {
      text: 'Center map here',
      classname: 'bold',
      icon: 'ol3-contextmenu/img/center.png',
      callback: center
    },
    {
      text: 'Some Actions',
      icon: 'ol3-contextmenu/img/view_list.png',
      items: [
        {
          text: 'Center map here',
          icon: 'ol3-contextmenu/img/center.png',
          callback: center
        },
        {
          text: 'Add a Marker',
          icon: 'ol3-contextmenu/img/pin_drop.png',
          callback: marker
        }
      ]
    },
    {
      text: 'Add a Marker',
      icon: 'ol3-contextmenu/img/pin_drop.png',
      callback: marker
    },
    '-' // this is a separator
  ];

  var contextmenu = new ContextMenu({
    width: 180,
    items: contextmenu_items
  });
  map.addControl(contextmenu);
  var popup = new ol.Overlay.Popup();
map.addOverlay(popup);


map.on('click', function (evt) {var layerpopup='';
var featuresArr=[]; var layersArr={}; var l=0;
    map.forEachFeatureAtPixel(evt.pixel,

    function (feature,layer) { 
if(layer){feature.layername=layer.get('name');
if(feature.getId()==undefined ){
if (!Date.now) { Date.now = function now() {return new Date().getTime(); };}
var addv=Date.now();
feature.setId("owgFeature"+addv+feature.layername); }
featuresArr.push(feature);}

    });
  
        if (featuresArr.length>0) { 
var htmlText='<div>';
var heightstyle='100px';
if(popupheightOWG!==0){heightstyle=popupheightOWG}
htmlText+='<div style="overflow-y: auto; resize:both;height:'+heightstyle+'">';//max-height: 160px;
for(var ii=0;ii<=featuresArr.length-1;ii++)
        {var att = featuresArr[ii].getProperties(); 
                
        htmlText+='<div id=tableAttributeAtl style="font-family: sans-serif;"><div style="font-size:13px; max-width: 200px; overflow-x: auto;">'+featuresArr[ii].layername+'</div><table width="10%" border="1" cellspacing="0" cellpadding="1">'
        for (var i in att)
{if(i=='geometry'&&typeof (att[i])=='object'){}else
{htmlText+='<tr align="center" >';
htmlText+='<td style="text-align: left;background: #53C2CF;color: white;font-family: sans-serif;border-style: solid;border-width: 0 1px 1px 0;border-color:white;"><font size="2">'+i+'</font></td>';
htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;border-style: solid;border-width: 0 1px 1px 0;border-color:white;background: #CBEDF1; text-align: left;">'+att[i]+'</td>';
htmlText+='</tr>';
}
}
htmlText+='</table></div>';

        
    }
htmlText+='</div><br><button onclick="EditeUpdateAttributes(this)" class=buttonclass id=id_EditeUpdateAttributes type="button" style="position:relative" title="click to start edit attributes" "><a style="font-size: 11px;">Edit</a></button><button id="id_UpdateAttributesB" class=buttonclass type="button" onclick="UpdateAttributes(this);"><a style="font-size: 11px;">Update</a></button><button id="id_ChangeTableAttribute" class=buttonclass type="button" onclick="ChangeTableAttribute(this);"><a style="font-size: 11px;">View</a></button><br>';
htmlText +='<br><button class=buttonclass type="button" title="click to resize popup window" onclick="UpdateSizePopUpFeatAtl(this);"><a style="font-size: 10px;">Resize</a></button>';
htmlText +='<a style="font-size: 11px;">w:</a><input class=sizePopupW id="id_sizePopupFeatAtlw" title="size popup width in pixel" type="text" style="font-size: 10px;" size="1" value="300">';
htmlText +='<a style="font-size: 11px;">h:</a><input class=sizePopupH id="id_sizePopupFeatAtlh" title="size popup height in pixel" type="text" style="font-size: 10px;" size="1" value="300"></div>';
popup.show(evt.coordinate, htmlText);
popup.container.featuresInf=featuresArr;
popup.container.viewTable='view2';
popup.container.getElementsByClassName('ol-popup-content')[0].style.resize="both";
popup.container.getElementsByClassName('ol-popup-content')[0].style.maxHeight="20000px";
if(popupheightOWG!==0)
{popup.container.getElementsByClassName('sizePopupH')[0].value=popupheightOWG.split('px')[0];
popup.container.getElementsByClassName('sizePopupW')[0].value=popupwidthOWG.split('px')[0];}
} else {
        
    }
});
function UpdateSizePopUpFeatAtl(button)
{
var popElem=button.parentNode.parentNode.parentNode;

popElem.getElementsByClassName('ol-popup-content')[0].style.width=popElem.getElementsByClassName('sizePopupW')[0].value+"px";
popElem.getElementsByClassName('ol-popup-content')[0].style.height=parseInt(popElem.getElementsByClassName('sizePopupH')[0].value)+80+"px";
popElem.getElementsByClassName('ol-popup-content')[0].childNodes[0].childNodes[0].style.width=popElem.getElementsByClassName('sizePopupW')[0].value+"px";
popElem.getElementsByClassName('ol-popup-content')[0].childNodes[0].childNodes[0].style.height=popElem.getElementsByClassName('sizePopupH')[0].value+"px";
popElem.sizePopupW=popElem.getElementsByClassName('sizePopupW')[0].value+"px";
popElem.sizePopupH=popElem.getElementsByClassName('sizePopupH')[0].value+"px";
popupheightOWG=popElem.getElementsByClassName('sizePopupH')[0].value+"px";
popupwidthOWG=popElem.getElementsByClassName('sizePopupW')[0].value+"px";
}
function EditeUpdateAttributes(button)
{

var featuresArr=button.parentNode.parentNode.parentNode.featuresInf; 
var popElem=button.parentNode.parentNode.parentNode;
     if (featuresArr.length>0) { 
var divElem=document.createElement('div');
var heightstyle='100px';var widthtstyle='300';
if(popElem.sizePopupH){heightstyle=popElem.sizePopupH;}
if(popElem.sizePopupW){widthtstyle=popElem.sizePopupW;}
var htmlText='<div style="overflow-y: auto; resize:both;height:'+heightstyle+'">';//max-height: 160px;
for(var ii=0;ii<=featuresArr.length-1;ii++)
        {var att = featuresArr[ii].getProperties(); 
        var  featID=featuresArr[ii].getId();
         if(popElem.viewTable=='view1')      
       {var htmlTextAdd='<div id=tableAttributeAtl2 style="font-family: sans-serif;"><div style="font-size:13px; max-width: 200px; overflow-x: auto;">'+featuresArr[ii].layername+'</div><table width="10%" border="1" cellspacing="0" cellpadding="1">';
       if(featuresArr[ii-1]&&featuresArr[ii-1].layername==featuresArr[ii].layername){htmlTextAdd=''}
        htmlText+=htmlTextAdd;
        if(htmlTextAdd!=='')
    {htmlText+='<tr align="center" >';
    for (var i in att)
{if(i=='geometry'&&typeof (att[i])=='object'){}else
{
htmlText+='<td style="text-align: left;background: #53C2CF;color: white;font-family: sans-serif;border-style: solid;border-width: 0 1px 1px 0;border-color:white;"><font size="2">'+i+'</font></td>';}};htmlText+='</tr>'}
     htmlText+='<tr>';
   for (var i in att)
{if(i=='geometry'&&typeof (att[i])=='object'){}else
{var varid=featuresArr[ii].layername+"_%"+i+"_%"+featID;
htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;border-style: solid;border-width: 0 1px 1px 0;border-color:white;background: #CBEDF1; text-align: left;"><textarea style="height:20px; width:100px;resize: both;" id="'+varid+'" type="text" size="10" >'+att[i]+'</textarea><div title="add image or video" onclick="addtableimage(this)" style="float:right; cursor:pointer;width: 20px; height: 15px;background:#0000ff"></div></td>';

}
};htmlText+='</tr>';
var htmlTextAdd='</table></div>';
if(featuresArr[ii+1]&&featuresArr[ii+1].layername==featuresArr[ii].layername){htmlTextAdd=''}
        htmlText+=htmlTextAdd;

}
else
{
       htmlText+='<div id=tableAttributeAtl2 style="font-family: sans-serif;"><div style="font-size:13px; max-width: 200px; overflow-x: auto;">'+featuresArr[ii].layername+'</div><table width="10%" border="1" cellspacing="0" cellpadding="1">'
        for (var i in att)
{if(i=='geometry'&&typeof (att[i])=='object'){}else
{var varid=featuresArr[ii].layername+"_%"+i+"_%"+featID;
htmlText+='<tr align="center" >';
htmlText+='<td style="text-align: left;background: #53C2CF;color: white;font-family: sans-serif;border-style: solid;border-width: 0 1px 1px 0;border-color:white;"><font size="2">'+i+'</font></td>';
htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;border-style: solid;border-width: 0 1px 1px 0;border-color:white;background: #CBEDF1; text-align: left;"><textarea style="height:20px; width:100px;resize: both;" id="'+varid+'" type="text" size="10" >'+att[i]+'</textarea><div title="add image or video" onclick="addtableimage(this)"  style="float:right; cursor:pointer;width: 20px; height: 15px;background:#0000ff;"></div></td>';
htmlText+='</tr>';
}
}
htmlText+='</table></div>';

}
        
    }
htmlText+='</div><br><button class=buttonclass id=id_EditeUpdateAttributes type="button" style="position:relative" title="click to start edit attributes" "><a style="font-size: 11px;">Edit</a></button><button id="id_UpdateAttributesB" class=buttonclass type="button" onclick="UpdateAttributes(this);"><a style="font-size: 11px;">Update</a></button><button id="id_ChangeTableAttribute" class=buttonclass type="button" onclick="ChangeTableAttribute(this);"><a style="font-size: 11px;">View</a></button><br>';
htmlText +='<br><button class=buttonclass type="button" title="click to resize popup window" onclick="UpdateSizePopUpFeatAtl(this);"><a style="font-size: 10px;">Resize</a></button>';
htmlText +='<a style="font-size: 11px;">w:</a><input class=sizePopupW id="id_sizePopupFeatAtlw" title="size popup width in pixel" type="text" style="font-size: 10px;" size="1" value="300">';
htmlText +='<a style="font-size: 11px;">h:</a><input class=sizePopupH id="id_sizePopupFeatAtlh" title="size popup height in pixel" type="text" style="font-size: 10px;" size="1" value="300"></div>';
divElem.innerHTML=htmlText;
}

popElem.childNodes[1].removeChild(popElem.childNodes[1].childNodes[0]);
popElem.childNodes[1].appendChild(divElem)
popElem.getElementsByClassName('sizePopupH')[0].value=heightstyle.split('px')[0];
popElem.getElementsByClassName('sizePopupW')[0].value=widthtstyle.split('px')[0];

/////////////////////////////////////////////////////////////////////////////////

 
 
 /////////////////////////////////////////////////////////
}

function addtableimage(e)
{ var td=e; 

 var body = document.body

var DivEditeLeg=document.createElement("div");DivEditeLeg.style.cursor="default";
DivEditeLeg.id="id_divTableImage";

DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="absolute";DivEditeLeg.style.left='4em';DivEditeLeg.style.top='2em';
DivEditeLeg.innerHTML='<div id="id_divTableImageLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:0px;top:0px;overflow:hidden; border: 1px solid black;"><a style="position:relative; top:20px"><br>'+
'<a>Select image file:</a><br>'+
'<input class=buttonclass title="Select image file from your computer" type="file" id="file_idImageTable"><input type="checkbox" disabled id="id_imageTableUpload" value="checkbox"/>Upload image to OpenWebGIS'+'<br>'+
'Or insert URL of image:<textarea id="id_imageTableTextArea" style="width: 250px; height: 20px;font-size:11px"></textarea><br>'+
'Or insert URL of Video or website:<textarea id="id_VideoTableTextArea" value="" style="width: 250px; height: 20px;font-size:11px"></textarea><br>'+
'<a>width:</a><input type="text" size="5" id="id_imageTableWidth" value="50"/><br>'+
'<a>height:</a><input type="text" size="5" id="id_imageTableHeight" value="50"/><br>'+
'<input type="checkbox" id="id_imageTableorSize"  onchange="" value="checkbox"/>Leave original size<br>'+
'<p style="left: 0px; bottom: 0px; position: relative; height: 15px;"><button class=buttonclass style="position: absolute; left: 0px; bottom: 0px;" type=button onclick=closeTableImageWin()>Close</button> <button class=buttonclass id= "id_OK_ImageTable" type=button style="position: absolute; right: 0px; bottom: 0px;" onclick=OK_ImageTable()>OK</button></p>';
'</div>';
if(!document.getElementById("id_divTableImageLeg"))
{body.appendChild(DivEditeLeg); }
document.getElementById('file_idImageTable').addEventListener('change', readSingleFileImage, false);
document.getElementById('id_OK_ImageTable').onclick=function(){OK_ImageTable(td);

document.getElementById("id_divTableImageLeg").childNodes[0].addEventListener("mousedown", saveXY, false);
document.getElementById("id_divTableImageLeg").childNodes[0].addEventListener("touchstart", saveXY, false);
}
var c; fileZIP=c;
}
function OK_ImageTable(td)
{var w=document.getElementById("id_imageTableWidth").value; var h=document.getElementById("id_imageTableHeight").value;
var myUrl0='';
myUrl0=document.getElementById("id_VideoTableTextArea").value; 
if(myUrl0!=='')
{var ddsst='';if(myUrl0.search(/youtube/g)!==-1){ddsst='//';if(myUrl0.search(/watch\?v=/g)!==-1){var tsy00=myUrl0.split('https://')[1];var tsy=myUrl0.split('http://')[1];if(typeof tsy00=='undefined' ){}else{tsy=tsy00;}if(typeof tsy=='undefined' ){tsy=myUrl0} tsy0=tsy.split('watch?v=')[0];tsy1=tsy.split('watch?v=')[1];myUrl0=tsy0+'embed/'+tsy1;}}
if(myUrl0.search(/youtu.be/g)!==-1){ddsst='//';var tsy=myUrl0.split('http://')[1];if(typeof tsy=='undefined' ){tsy=myUrl0} tsy0=tsy.split('youtu.be/')[1];myUrl0='www.youtube.com/embed/'+tsy0;}

td.previousElementSibling.value="<iframe width="+w+" height="+h+" src="+ddsst+myUrl0+" frameborder=0 allowfullscreen></iframe>";  closeTableImageWin();return;}
if(fileZIP){if(fileZIP.type=="image/jpeg"||fileZIP.type=="image/png"||fileZIP.type=="image/tiff"||fileZIP.type=="image/gif"||fileZIP.type=="image/bmp"||fileZIP.type=="image/tif"){} else{alert("ERROR. file is not image");return;}}
myUrl=document.getElementById("id_imageTableTextArea").value; 

if(myUrl.length==0)
{
var contents;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { contents = e.target.result;
 if(document.getElementById('id_imageTableorSize').checked==true)
 {var imgN=document.createElement("img");
 imgN.src=contents;w=imgN.width; h=imgN.height;}
  if(document.getElementById('id_imageTableUpload').checked==true)
 {
 /*if(fileZIP.size>8000000){alert("size of the file could not be more than 8 MB"); return;}
 try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp.open('POST','/image.php?rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
//xmlhttp.setRequestHeader("Content-type", fileZIP.type);
 xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("no data");return;}
//var varlink=xmlhttp.responseText;
td.previousElementSibling.value="<img src="+window.location.origin+"/images/"+xmlhttp.responseText+" style=width:"+w+"px;height:"+h+"px>";
}}
xmlhttp.send('value='+contents+'&name='+fileZIP.name);*/
 }
 else
{td.previousElementSibling.value="<img src="+contents+" style=width:"+w+"px;height:"+h+"px>";}
closeTableImageWin();
 } 
 r.readAsDataURL(fileZIP); } else {  alert("Failed to load file"); }
 }
 else{
 if(myUrl.length<5)
{alert("error in the url"); return;}
 if(document.getElementById('id_imageTableorSize').checked==true)
 {var imgN=document.createElement("img");
 imgN.src=document.getElementById("id_imageTableTextArea").value;w=imgN.width; h=imgN.height;}
 td.previousElementSibling.value="<img src="+document.getElementById("id_imageTableTextArea").value+" style=width:"+w+"px;height:"+h+"px>";
 closeTableImageWin();
 }
 

}
function readSingleFileImage(evt){fileZIP = evt.target.files[0]; }
function closeTableImageWin(){document.getElementById("id_divTableImage").parentNode.removeChild(document.getElementById("id_divTableImage"));}

function UpdateAttributes(button)
{var featuresArr=button.parentNode.parentNode.parentNode.featuresInf; 
var popElem=button.parentNode.parentNode.parentNode;
 x=confirm('Are you sure?');
 if (x==true) {
featuresArr.forEach(
function(feature_arr)
{
var att= feature_arr.getProperties();
for(var h in att)
{
if( document.getElementById(feature_arr.layername+"_%"+h+"_%"+feature_arr.getId()))
{
var data=document.getElementById(feature_arr.layername+"_%"+h+"_%"+feature_arr.getId()).value;
var obj={}; obj[h]=data;
feature_arr.setProperties(obj);
}  } } )
 }
 else { }
  ChangeTableAttribute(button);
}
function ChangeTableAttribute(button)
{
var featuresArr=button.parentNode.parentNode.parentNode.featuresInf; 
var popElem=button.parentNode.parentNode.parentNode;
     if (featuresArr.length>0) { 
var divElem=document.createElement('div');
var heightstyle='100px';var widthtstyle='300';
if(popElem.sizePopupH){heightstyle=popElem.sizePopupH;}
if(popElem.sizePopupW){widthtstyle=popElem.sizePopupW;}
var htmlText='<div style="overflow-y: auto; resize:both;height:'+heightstyle+'">';//max-height: 160px;
for(var ii=0;ii<=featuresArr.length-1;ii++)
        {var att = featuresArr[ii].getProperties(); 
       var viewType='view2'; if (popElem.getElementsByTagName('textarea').length==0){viewType='view2'}else{viewType='view1'}
         if(popElem.viewTable==viewType)      
       {var htmlTextAdd='<div id=tableAttributeAtl style="font-family: sans-serif;"><div style="font-size:13px; max-width: 200px; overflow-x: auto;">'+featuresArr[ii].layername+'</div><table width="10%" border="1" cellspacing="0" cellpadding="1">';
       if(featuresArr[ii-1]&&featuresArr[ii-1].layername==featuresArr[ii].layername){htmlTextAdd=''}
        htmlText+=htmlTextAdd;
        if(htmlTextAdd!=='')
    {htmlText+='<tr align="center" >';
    for (var i in att)
{if(i=='geometry'&&typeof (att[i])=='object'){}else
{
htmlText+='<td style="text-align: left;background: #53C2CF;color: white;font-family: sans-serif;border-style: solid;border-width: 0 1px 1px 0;border-color:white;"><font size="2">'+i+'</font></td>';}};htmlText+='</tr>'}
     htmlText+='<tr>';
   for (var i in att)
{if(i=='geometry'&&typeof (att[i])=='object'){}else
{
htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;border-style: solid;border-width: 0 1px 1px 0;border-color:white;background: #CBEDF1; text-align: left;">'+att[i]+'</td>';

}
};htmlText+='</tr>';
var htmlTextAdd='</table></div>';
if(featuresArr[ii+1]&&featuresArr[ii+1].layername==featuresArr[ii].layername){htmlTextAdd=''}
        htmlText+=htmlTextAdd;

}
else
{
       htmlText+='<div id=tableAttributeAtl style="font-family: sans-serif;"><div style="font-size:13px; max-width: 200px; overflow-x: auto;">'+featuresArr[ii].layername+'</div><table width="10%" border="1" cellspacing="0" cellpadding="1">'
        for (var i in att)
{if(i=='geometry'&&typeof (att[i])=='object'){}else
{htmlText+='<tr align="center" >';
htmlText+='<td style="text-align: left;background: #53C2CF;color: white;font-family: sans-serif;border-style: solid;border-width: 0 1px 1px 0;border-color:white;"><font size="2">'+i+'</font></td>';
htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;border-style: solid;border-width: 0 1px 1px 0;border-color:white;background: #CBEDF1; text-align: left;">'+att[i]+'</td>';
htmlText+='</tr>';
}
}
htmlText+='</table></div>';

}
        
    }
htmlText+='</div><br><button onclick="EditeUpdateAttributes(this)" class=buttonclass id=id_EditeUpdateAttributes type="button" style="position:relative" title="click to start edit attributes" "><a style="font-size: 11px;">Edit</a></button><button id="id_UpdateAttributesB" class=buttonclass type="button" onclick="UpdateAttributes(this);"><a style="font-size: 11px;">Update</a></button><button id="id_ChangeTableAttribute" class=buttonclass type="button" onclick="ChangeTableAttribute(this);"><a style="font-size: 11px;">View</a></button><br>';
htmlText +='<br><button class=buttonclass type="button" title="click to resize popup window" onclick="UpdateSizePopUpFeatAtl(this);"><a style="font-size: 10px;">Resize</a></button>';
htmlText +='<a style="font-size: 11px;">w:</a><input class=sizePopupW id="id_sizePopupFeatAtlw" title="size popup width in pixel" type="text" style="font-size: 10px;" size="1" value="300">';
htmlText +='<a style="font-size: 11px;">h:</a><input class=sizePopupH id="id_sizePopupFeatAtlh" title="size popup height in pixel" type="text" style="font-size: 10px;" size="1" value="300"></div>';
divElem.innerHTML=htmlText;
}
if (popElem.getElementsByTagName('textarea').length==0)
{if(popElem.viewTable=='view2'){popElem.viewTable='view1'}else{popElem.viewTable='view2'}}
popElem.childNodes[1].removeChild(popElem.childNodes[1].childNodes[0]);
popElem.childNodes[1].appendChild(divElem)
popElem.getElementsByClassName('sizePopupH')[0].value=heightstyle.split('px')[0];
popElem.getElementsByClassName('sizePopupW')[0].value=widthtstyle.split('px')[0];

}
  
  var removeMarker = function(obj){
    vectorLayerMarkers.getSource().removeFeature(obj.data.marker);
  };
  var removeMarkerItem = {
    text: 'Remove this Marker',
    classname: 'marker',
    callback: removeMarker
  };

  contextmenu.on('open', function(evt){
    var feature = map.forEachFeatureAtPixel(evt.pixel, function(ft, l){
      return ft;
    });
    if (feature && feature.get('type') == 'removable') {
      contextmenu.clear();
      removeMarkerItem.data = {
        marker: feature
      };
      contextmenu.push(removeMarkerItem);
    } else {
      contextmenu.clear();
      contextmenu.extend(contextmenu_items);
      contextmenu.extend(contextmenu.getDefaultItems());
    }
  });

  map.on('pointermove', function(e) {
    if (e.dragging) return;
         
    var pixel = map.getEventPixel(e.originalEvent);
       var hit = map.hasFeatureAtPixel(pixel);
    
    map.getTarget().style.cursor = hit ? 'pointer' : '';
     displayFeatureChange(pixel);
  });
  var featureOverlay = new ol.layer.Vector({
        source: new ol.source.Vector(),
  map: map,
  style: new ol.style.Style({
   image: new ol.style.Circle(  ({
            radius: 4,
            stroke: new ol.style.Stroke({
          color: [255,0,0,0.6],
          width: 2
        }),
        fill: new ol.style.Fill({
          color: [255,0,0,0.2]
        })
        })  ),
    stroke: new ol.style.Stroke({
      color: '#f00',
      width: 1
    }),
    fill: new ol.style.Fill({
      color: 'rgba(255,0,0,0.1)'
    })
  })
});

featureOverlay.set('name', '');
 var highlight;
    var displayFeatureChange = function (pixel) {
var layer_sel='';
        var feature = map.forEachFeatureAtPixel(pixel, function (feature,layer) {
            layer_sel=layer;
            return feature;
        });
        if (feature !== highlight) {
            if (highlight) {
                featureOverlay.getSource().removeFeature(highlight);
            }
            if (feature) {
                featureOverlay.getSource().addFeature(feature);
            }
            if(layer_sel)
            {featureOverlay.set('name',layer_sel.get('name') );     }
            highlight = feature;
        }

    };
   var layerSwitcher = new ol.control.LayerSwitcher({
        tipLabel: 'LayerSwitcher' // Optional label for button
    });
map.addControl(layerSwitcher);
layer_vector_group.getLayers().push(vectorLayerMarkers);
vectorLayerMarkers.set('name', 'Markers');

var select = new ol.interaction.Select();
map.addInteraction(select);

var modify = new ol.interaction.Modify({
        features: select.getFeatures(),
        //style: overlayStyle
      });
//map.addInteraction(modify);
var style_select = new ol.style.Style({
 image: new ol.style.Circle(  ({
            radius: 4,
            stroke: new ol.style.Stroke({
          color: [255,0,0,0.6],
          width: 2
        }),
        fill: new ol.style.Fill({
          color: [255,0,0,0.2]
        })
        })  ),
        stroke: new ol.style.Stroke({
          color: [255,0,0,0.6],
          width: 2
        }),
        fill: new ol.style.Fill({
          color: [255,0,0,0.2]
        })
        //zIndex: 1
      });

select.on('select', function(evt){
    var selected = evt.selected;
    var deselected = evt.deselected;
    
    if (selected.length) {
        selected.forEach(function(feature){
            console.info(feature);
            feature.setStyle(style_select);
        });
    } else {
        deselected.forEach(function(feature){
            console.info(feature);
            feature.setStyle(null);
        });
    }
});
var FormatCoordinat = function(dgts)
{  return (    function(coord1) {        var coord2 = [ coord1[0],coord1[1]]; 
       var coord=ol.coordinate.toStringXY(coord2,dgts);
       coord='Lon:'+coord.split(",")[0]+", "+'Lat:'+coord.split(",")[1]
       return coord;
  });        
}
var CoordPosition = new ol.control.MousePosition({
        coordinateFormat: FormatCoordinat(4),
        projection: 'EPSG:4326',
        target: document.getElementById('coordinat_position_id'),
        undefinedHTML: '&nbsp;'      });      
        map.addControl(CoordPosition);
        map.addControl(new ol.control.ScaleLine());map.addControl(new ol.control.ZoomSlider());
                //new ol.control.FullScreen();map.addControl(new ol.control.ZoomToExtent());
document.addEventListener("mouseup", clearXY, false); 
document.addEventListener("touchend", clearXY, false); 
  function saveXY(obj_event) { 
   
    if (obj_event) {
          if(obj_event.touches){x = obj_event.pageX||obj_event.touches[0].pageX;}else{x = obj_event.pageX}
        if(obj_event.touches){y = obj_event.pageY||obj_event.touches[0].pageY;}else{y = obj_event.pageY}
    }
    else {
      x = window.event.clientX;
      y = window.event.clientY;
      if (ie) {
        y -= 2;
        x -= 2;
      }
    }

    x_block = obj_event.currentTarget.offsetLeft;
    y_block = obj_event.currentTarget.offsetTop;
    
   
    delta_x = x_block - x;
    delta_y = y_block - y;
Movewindowblock=obj_event.currentTarget;

document.addEventListener("mousemove", moveBlock, false);
document.addEventListener("touchmove", moveBlock, false);


    }
  function clearXY() { 
   
//Movewindowblock.removeEventListener("mousemove",moveBlock, false);
//Movewindowblock.removeEventListener("touchmove",moveBlock, false);

document.removeEventListener("mousemove",moveBlock, false);
document.removeEventListener("touchmove",moveBlock, false);

   
  }
  function moveBlock(obj_event) {
if(Movewindowblock.style.right){Movewindowblock.style.right='';}
    if (obj_event) {
      if(obj_event.touches){x = obj_event.pageX||obj_event.touches[0].pageX;}else{x = obj_event.pageX}
        if(obj_event.touches){y = obj_event.pageY||obj_event.touches[0].pageY;}else{y = obj_event.pageY}
    }
    else {
      x = window.event.clientX;
      y = window.event.clientY;
      if (ie) {
        y -= 2;
        x -= 2;
      }
    }
   
    new_x = delta_x + x;new_y = delta_y + y;

     Movewindowblock.style.left = new_x + "px";Movewindowblock.style.top = new_y + "px";
   
  }
    </script>

  </body>
 
</html>
